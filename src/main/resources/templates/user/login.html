<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<meta charset="UTF-8">
<link href="/css/common.css" type="text/css" rel="stylesheet">
<link href="/css/mod_dark.css" type="text/css" rel="stylesheet">
<link href="/font/font.css" type="text/css" rel="stylesheet">
<script type="text/javascript" th:src="@{/js/cmmn.js}"></script>
<script type="text/javascript" th:src="@{/js/input.js}"></script>
<script type="text/javascript" th:src="@{/js/tree.js}"></script>  
<!-- <script type="text/javascript" th:src="@{/js/fontawesome.js}"></script> -->

<title>::딥러닝기반 식별체계 데이터구축::</title>
</head>
<body>
<form id="frm" th:action="@{/login}" method="post" th:object="${user}">
  <div class="container-wrap">
    <div class="bg-login">
      <div class="bg-pattern"></div>
      <div class="bg-content">
        <div class="log-info">
          <div class="bg-pattern1"></div>
          <div class="group-info">
            <div class="logo"></div>
            <div class="txt">딥러닝 기반<br>함정/선박 식별체계<br>데이터 구축 시스템</div>
            <div class="subtxt">Deep Learning-based<br>Warship/Ship Identification System</div>
          </div>
        </div>
        
        <div class="log-input">
          <div class="txt">LOG IN</div>
          <div class="log-wrap">
            <div class="input-wrap1">
            <input type="text" class="login engNum" th:field="*{username}" autocomplete="off" placeholder="아이디를 입력해 주세요." title="아이디 입력">
            <span id="valid_username" class="inform valid"></span>
            </div>
            <div class="input-wrap2">
            <input type="password" class="login" id="userPw" th:field="*{password}" autocomplete="off" placeholder="비밀번호를 입력해 주세요." title="비밀번호 입력">
            <span class="inform valid" id="valid_password"></span>
            </div>
            <button type="button"  class="btn-login"  title="로그인하기">로그인</button>
          </div>
          <span id="valid_loginMsg" class="inform valid" th:text="${#request.getAttribute('loginFailMsg')}"></span>
        </div>
        
      </div>
      <div class="bg-bottom">
        <a href="javascript:;"  class="btn-regist">회원가입</a>
      </div>
    </div>
  </div>
  </form>
   <!--모달팝업:메시지 -->
    <div class="pop-wrap msgPop" style="z-index:500">
    <div class="pop_container">
      <div class="pop-bg">
        <div class="pop-head"><div class="pop-title">메시지</div></div>
        <div class="pop-body msgBody" style="text-align:center;">
        </div>
        <div class="pop-footer">
          <div class="pop-btn-group">
            <button type="button" class="btn-m-confirm msgConfirm" title="닫기">확인</button>
            <button type="button" class="btn-m-cancel msgClose" title="닫기">닫기</button>
          </div>
        </div>
      </div>
    </div>
    </div>
    <!--  -->
  <!--모달팝업:회원가입 start-->
  <div class="pop-wrap" id="memberRegist">
  <!--모달팝업:부대-->
  <div class="pop-wrap unitPop" >
    <div class="pop_container">
      <div class="pop-bg">
        <div class="pop-head"><div class="pop-title">부대정보</div></div>
        <div class="pop-body" style="padding:0px;">
          <div class="graph4" style="height:360px;">
            <div class="gridCont05">
				<div class="treeBox">
				</div>
            </div>
          </div>
        </div>
         <div class="pop-footer">
	          <div class="pop-btn-group">
	            <button type="button" class="btn-m-cancel unitPopBtn" title="취소">취소</button>
	            <button type="button" class="btn-m-confirm unitPopBtn" title="확인하기">확인</button>
	          </div>
	     </div>
      </div>
    </div>
  </div>
  
    <form id="regFrm" th:action method="post" th:object="${user}">
    <div class="pop_container">
      <div class="pop-bg">
        <div class="pop-head"><div class="pop-title">회원가입</div></div>
        <div class="pop-body">
       
          <ul class="pop-list">
            <li>
              <div class="input-group">
                <label class="basic" for="userId">사용자 ID</label>
                <input type="text"  th:field="*{userId}" autocomplete="off" class="basic warn engNum" title="사용할 ID 입력" placeholder="6~25자 이내로 입력.">              
              </div>
              <span id="valid_userId" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="password">비밀번호</label>
                <input type="password" id="password" th:field="*{userPw}" autocomplete="off" required="required" class="basic" title="사용할 비밀번호 입력" placeholder="소문자, 특수기호 포함 8~20자 이내로 입력">
                <!--<div class="warning">*비밀번호 형식이 다릅니다.</div>-->
                
              </div>
              <span id="valid_userPw" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="userNm">성명</label>
                <input type="text" id="userNm" th:field="*{userNm}" autocomplete="off" class="basic kor" title="사용자 이름을 입력" placeholder="사용자 이름을 입력해 주세요.">
                
              </div>
              <span id="valid_userNm" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="deptNm">부서</label>
                <input type="text" th:field="*{deptNm}" autocomplete="off" class="basic korNum" title="부서명 입력" placeholder="부서명을 정확히 입력해 주세요.">
                
              </div>
              <span id="valid_deptNm" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="specNm">직별</label>
                <input type="text" th:field="*{specNm}" autocomplete="off" class="basic korNum" title="직별 입력" placeholder="직별명을 정확히 입력해 주세요.">
              </div>
              <span id="valid_specNm" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="userUnit">소속부대</label>
                <input type="text" th:field="*{unitNm}" autocomplete="off" class="basic " title="소속부대 입력" readOnly placeholder="소속부대 정확히 입력해 주세요." onclick="popInit();">
                <input type="hidden" th:field="*{unitId}">
              </div>
              <span id="valid_unitNm" class="inform1 valid"></span>
            </li>
            <li>
              <div class="input-group">
                <label class="basic" for="rankCd">계급</label>
                <select class="basic" th:field="*{rankCd}">
					<option th:each="val : ${rankCds}" th:value="${val?.cd}"
						th:text="${val?.cdNm}"></option>
				</select>
              </div>
              <span id="valid_rankCd" class="valid"></span>
            </li>
             <li>
              <div class="input-group">
                <label class="basic" for="authority">권한</label>
                 <div th:each="r : ${authorities}" class="input-group form-check form-check-inline">
					<input type="radio" th:field="*{authority}" th:value="${r.name}"
						class="form-check-input" th:checked="${user.authority == r.name}">
					<label th:for="${#ids.prev('authority')}" th:text="${r.desc}"
						class="form-check-label"></label>
				 </div>
				 <input type="hidden" id="authority" name="authority" value="ROLE_USER">
              </div>
              <span id="valid_authority" class="valid"></span>
            </li>
          </ul>
        </div>
       
        <div class="pop-footer">
          <div class="pop-btn-group">
            <button type="button"  class="btn-m-cancel" title="취소하기">취소</button>
            <button type="button"  class="btn-m-confirm" title="확인하기">확인</button>
          </div>
        </div>
      </div>
    </div>
    </form>

  </div>
  <!--모달팝업:회원가입 end-->

</body>
<script th:inline="javascript"> 
    let modal = document.getElementById('memberRegist');
    window.addEventListener('DOMContentLoaded', function(){
		try{
			treeInit(document.querySelector('.treeBox'));
			document.getElementById('username').focus();
		    if(localStorage.hasOwnProperty(nis.storageKey)){gfn_clearStorage();}

			document.querySelector('#userPw').addEventListener("keyup", (e) => {
				e.preventDefault();
				const keyCode = e.keyCode;
				if(keyCode == 13){ // Enter key
					login();
				}
			});
			
			document.querySelector('.btn-login').addEventListener("click", (e) => {
				e.preventDefault();
				login();
			});
			
			document.querySelector('.btn-regist').addEventListener("click", (e) => {
				e.preventDefault();
				gfn_initObj(document.getElementById('regFrm'));
				document.getElementById('authority3').checked = true;
				modal.style.display = "block";
			});
			
			document.querySelectorAll('.btn-m-cancel').forEach((btnCancel) => {
		    	btnCancel.addEventListener('click', (e) => {
		    		e.preventDefault();
		    		if(e.target.classList.contains('unitPopBtn')){
		    			modal = document.querySelector('.unitPop');
		    		}
		    		else if(e.target.classList.contains('msgClose')){
		    			modal = document.querySelector('.msgPop');
		    		}
		    		else{
		    			modal = document.getElementById('memberRegist');
		    			document.getElementById('unitId').value = '';
    					document.getElementById('unitNm').value = '';
		    			gfn_removeValidHtml(regFrm,'span');
						
		    		}
		    		modal.style.display = "none";
		    		
		    	});
		    });
			
		 }catch(e){console.log(e);}
		
	});
    
    const popInit = () => {
		let list = null;
		gfn_asyncCallNoLogin("/unitInfo",'GET',{}).then((data) => {
			for(key in data) {
                if(key.indexOf('list') > -1){
                   	list = data[key];
				}
			}
			const treeBox = document.querySelector('.treeBox');
			treeBox.innerHTML = '';
			let treejs = createInitTree(treeBox,list,false);
			if(list != null && list.length > 0){
				createTreeNoChk(list,treejs);
			}

		}).then(() => {
			document.querySelector('.treeBox').querySelectorAll('.treejs-label').forEach((label) => {
				let li = label.parentNode;
				if(li.getAttribute('data-id') === document.getElementById('unitId').value){
					label.classList.add('on');
					return false;
	    		}
			});  	
			
		});
		let popLayer = document.querySelector('.unitPop');
		popLayer.style.display = "block";
	}
    
    const login = () => {
    	gfn_removeValidHtml(frm,'span');
    	let requiredParams = {username: "사용자 아이디"
    			             ,password: "사용자 비밀번호"};

    	if(gfn_valid(document.getElementById('frm'),requiredParams)){
    		frm.submit();
    	}
    }
    
    document.addEventListener('DOMContentLoaded',() => {
 	   const whatMode = localStorage.getItem('whatMode'); //whatMode 아이템 값 불러오기
 	   if (whatMode === "false") { // 체크 여부가 false라면, 라이트모드입니다. 이 때 false는 문자열 타입이므로 "" 안에 적어야 합니다.
 		  return !1; // 라이트모드이므로 아무런 행동을 할 필요가 없습니다.
 	   }  
 	   else { // 다크모드라면 
 	       document.querySelector('body').classList.add('darkmode');
 	   }
    });
    
    
    const saveFunc = () => {
    	let authoities = document.getElementsByName('authority');
    	authoities.forEach((auth,index)=> {
    		if(auth.checked){
    			if(index === 0){
    				document.getElementById('authority').value="ROLE_ADMIN";
    			}
    			else if(index === 1){
    				document.getElementById('authority').value="ROLE_MANAGER";
    			}
    			else{
    				document.getElementById('authority').value="ROLE_USER";
    			}
    		}
    		
    		
    	});
    	gfn_removeValidHtml(regFrm,'span');
    	let requiredParams = {userId : "사용자 아이디"
                            , userPw : "사용자 비밀번호"
                            , userNm : "사용자 성명"
                            , deptNm : "부서"
                            , specNm : "직책"
                            , unitNm : "소속부대"
                            , authority : "권한"
                            };
    	gfn_asyncCallNoLogin('/register','POST',document.getElementById('regFrm'),requiredParams).then((data) => {
			for(key in data) {
				if(key.indexOf('success_msg') > -1){
					msgCall(data[key]+"<br> 로그인 페이지로 이동합니다.",true);
					break;
				}
				if(key.indexOf('fail_msg') > -1){
					msgCall(data[key],false);
					break;
				}
				if(key.indexOf('valid') > -1){
					let valid = document.getElementById(key); 
					valid.innerHTML = data[key];
				}
			}
		});
    }
	
    
	const msgCall = (msg,isSuccess) => {
		try{
			console.log("msgCall");
			document.querySelector('.msgPop').style.display = "block";
			if(isSuccess){
				document.querySelector(".msgBody").innerHTML = "<strong><p>"+msg+"</p></strong>";	
				if(document.querySelector('.msgConfirm').style.display === 'none'){
					document.querySelector('.msgConfirm').style.display = "";
				}
				document.querySelector('.msgClose').style.display = "none";

			}else{
				document.querySelector(".msgBody").innerHTML = "<strong><p'>"+msg+"</p></strong>";
				document.querySelector('.msgConfirm').style.display = "none";
				if(document.querySelector('.msgClose').style.display === 'none'){
					document.querySelector('.msgClose').style.display = "";
				} 
			}
			
	    }catch(e){
	    	console.error(e);
	    }
    }
	
	document.querySelectorAll('.btn-m-confirm').forEach((confirmCancel) => {
		confirmCancel.addEventListener('click', (e) => {
			console.log("e:",e.target);
			e.preventDefault();
			if(e.target.classList.contains('unitPopBtn')){
    			modal = document.querySelector('.unitPop');
    			let chkObj = false;
    			document.querySelectorAll('.treejs-label').forEach((label) => {
    				if(label.classList.contains('on')){
    					chkObj = true;
    					console.log(label.innerText);
    					document.getElementById('unitId').value = label.parentNode.getAttribute('data-id');
    					document.getElementById('unitNm').value = label.innerText;
    					return false;
		    		}
    				
    			});  	
    			if(!chkObj){
    				msgCall('부대정보를 선택하세요.',false);
    				return;
    			}
    			modal.style.display = "none";
    		}
			else if(e.target.classList.contains('msgConfirm')){
				modal = document.querySelector('.msgPop');
    			modal.style.display = "none";
				modal = document.getElementById('memberRegist');
    			modal.style.display = "none";
    			
    			
    		}
    		else{
    			modal = document.getElementById('memberRegist');
    			saveFunc();
				
    		}
		});
	});

    
</script>
</html>